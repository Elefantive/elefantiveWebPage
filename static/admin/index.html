<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager â€” Elefantive</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Helper: check if a file path is a video
    function isVideo(path) {
      if (!path) return false;
      return /\.(mp4|webm|mov)$/i.test(path);
    }

    var ProductPreview = createClass({
      render: function() {
        var entry = this.props.entry;
        var title = entry.getIn(['data', 'title']) || '';
        var image = entry.getIn(['data', 'image']);
        var price = entry.getIn(['data', 'price']);
        var introWidget = this.props.widgetFor('intro');
        var featured = entry.getIn(['data', 'featured']);
        var versions = entry.getIn(['data', 'versions']);

        var imgSrc = image ? this.props.getAsset(image).toString() : null;

        var s = {
          wrap: { fontFamily: "'Josefin Sans', sans-serif", color: '#231F20', padding: '2rem', background: '#f7f8f7', minHeight: '100%' },
          header: { textAlign: 'center', marginBottom: '1.5rem' },
          h1: { fontFamily: "'Baloo 2', cursive", fontSize: '2.2rem', fontWeight: 700, marginBottom: '0', lineHeight: 1.3 },
          hero: { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem', alignItems: 'start', marginBottom: '2.5rem' },
          heroText: { display: 'flex', flexDirection: 'column', gap: '1.5rem' },
          heroImg: { width: '100%', borderRadius: '8px', boxShadow: '0 4px 16px rgba(0,0,0,0.08)' },
          intro: { fontSize: '1.15rem', color: '#3a3536', lineHeight: 1.8, textAlign: 'left', listStylePosition: 'inside' },
          grid: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', maxWidth: '1000px', margin: '0 auto' },
          mainImg: { width: '100%', borderRadius: '8px', boxShadow: '0 4px 16px rgba(0,0,0,0.08)' },
          thumbGrid: { display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '0.5rem', marginTop: '0.75rem' },
          thumb: { width: '100%', aspectRatio: '1', objectFit: 'cover', borderRadius: '4px', border: '2px solid #d0d5d2' },
          thumbVidWrap: { position: 'relative', aspectRatio: '1' },
          thumbVid: { width: '100%', height: '100%', objectFit: 'cover', borderRadius: '4px', border: '2px solid #2A706C' },
          thumbPlay: { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%,-50%)', color: '#fff', fontSize: '1rem', textShadow: '0 1px 3px rgba(0,0,0,0.5)' },
          price: { fontSize: '1.3rem', fontWeight: 600, color: '#2A706C', marginBottom: '1rem' },
          body: { lineHeight: 1.8, marginBottom: '1.5rem' },
          btn: { display: 'inline-block', padding: '0.75rem 1.8rem', background: '#2A706C', color: '#fff', borderRadius: '8px', fontWeight: 600, textDecoration: 'none', marginRight: '0.5rem', marginBottom: '0.5rem' },
          btnSec: { display: 'inline-block', padding: '0.75rem 1.8rem', background: 'transparent', color: '#2A706C', borderRadius: '8px', fontWeight: 600, textDecoration: 'none', border: '2px solid #2A706C' },
          badge: { display: 'inline-block', background: '#2A706C', color: '#fff', fontSize: '0.75rem', padding: '0.2rem 0.6rem', borderRadius: '3px', marginBottom: '0.75rem' },
          versionWrap: { marginBottom: '2.5rem', paddingTop: '1.5rem', borderTop: '2px solid #85908A' },
          versionTitle: { fontFamily: "'Baloo 2', cursive", fontSize: '1.6rem', fontWeight: 700, color: '#2A706C', marginBottom: '1rem' }
        };

        // Helper: build thumbnails from unified gallery (auto-detect image vs video)
        function buildThumbs(gal) {
          var t = [];
          if (gal && gal.size > 0) {
            gal.forEach(function(item, i) {
              if (isVideo(item)) {
                t.push(h('div', { key: 'g' + i, style: s.thumbVidWrap },
                  h('video', { src: item, style: s.thumbVid, muted: true, preload: 'metadata' }),
                  h('span', { style: s.thumbPlay }, '\u25B6')
                ));
              } else {
                t.push(h('img', { key: 'g' + i, src: item, style: s.thumb }));
              }
            });
          }
          return t;
        }

        // Find first image in gallery for main display
        function firstImage(gal) {
          if (!gal || gal.size === 0) return null;
          for (var i = 0; i < gal.size; i++) {
            if (!isVideo(gal.get(i))) return gal.get(i);
          }
          return gal.get(0); // fallback to first item
        }

        // Build version sections or fallback to single layout
        var contentSections = [];

        if (versions && versions.size > 0) {
          versions.forEach(function(ver, vi) {
            var vName = ver.get('name') || 'Version ' + (vi + 1);
            var vGallery = ver.get('gallery');
            var vDetails = ver.get('details') || '';
            var vThumbs = buildThumbs(vGallery);
            var vFirstImg = firstImage(vGallery);

            contentSections.push(
              h('div', { key: 'ver' + vi, style: vi > 0 ? s.versionWrap : { marginBottom: '2.5rem' } },
                h('h2', { style: s.versionTitle }, vName),
                h('div', { style: s.grid },
                  h('div', {},
                    vFirstImg ? h('img', { src: vFirstImg, style: s.mainImg }) : null,
                    vThumbs.length > 1 ? h('div', { style: s.thumbGrid }, vThumbs) : null
                  ),
                  h('div', {},
                    h('div', { style: s.body, dangerouslySetInnerHTML: { __html: vDetails } }),
                    h('a', { style: s.btn }, 'Order by Email')
                  )
                )
              )
            );
          });
        }

        return h('div', { style: s.wrap },
          // Header
          h('div', { style: s.header },
            featured ? h('span', { style: s.badge }, 'Featured') : null,
            h('h1', { style: s.h1 }, title)
          ),
          // Hero
          h('div', { style: s.hero },
            h('div', { style: s.heroText },
              introWidget ? h('div', { style: s.intro, className: 'preview-intro' }, introWidget) : null,
              h('a', { style: s.btn }, 'Order by Email')
            ),
            imgSrc ? h('img', { src: imgSrc, style: s.heroImg }) : null
          ),
          // Content sections (versions or single)
          h('div', {}, contentSections)
        );
      }
    });

    CMS.registerPreviewStyle('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&family=Josefin+Sans:wght@300;400;600&display=swap');
    CMS.registerPreviewStyle('.preview-intro ul, .preview-intro ol { padding-left: 1.5rem; margin: 0.5rem 0; } .preview-intro li { margin-bottom: 0.3rem; line-height: 1.6; } .preview-intro li p { margin: 0; } .preview-intro p { margin: 0 0 0.75rem 0; } .preview-intro p:last-child { margin-bottom: 0; }', { raw: true });
    CMS.registerPreviewTemplate('products', ProductPreview);

    // "media" widget: file widget (shows all files) + image/video preview
    var fileWidget = CMS.getWidget('file');
    var FileControl = fileWidget.control;
    var FilePreview = fileWidget.preview;

    var MediaControl = createClass({
      render: function() {
        var value = this.props.value || '';
        var isImg = /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(value);
        var isVid = /\.(mp4|webm|mov)$/i.test(value);

        // Preview above the native file control
        var preview = null;
        if (value && isImg) {
          preview = h('div', { style: { marginBottom: '8px', maxWidth: '300px', borderRadius: '5px', overflow: 'hidden', border: '2px solid #dfdfe3' } },
            h('img', { src: value, style: { width: '100%', display: 'block' } })
          );
        } else if (value && isVid) {
          preview = h('div', { style: { marginBottom: '8px', maxWidth: '300px', borderRadius: '5px', overflow: 'hidden', border: '2px solid #dfdfe3', background: '#1a1a2e', padding: '24px', textAlign: 'center' } },
            h('span', { style: { color: '#fff', fontSize: '2rem', display: 'block' } }, '\u25B6'),
            h('span', { style: { color: '#aaa', fontSize: '0.75rem' } }, value.split('/').pop())
          );
        }

        return h('div', {},
          preview,
          h(FileControl, this.props)
        );
      }
    });

    CMS.registerWidget('media', MediaControl, FilePreview);
  </script>
</body>
</html>
