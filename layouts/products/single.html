{{ define "main" }}
<article class="product-detail">
  <div class="container">
    {{/* ===== COMMON: Title ===== */}}
    <div class="product-detail-header">
      <h1>{{ .Title }}</h1>
    </div>

    {{/* ===== COMMON: Hero (intro + main image) ===== */}}
    <div class="product-hero">
      <div class="product-hero-text">
        {{ with .Params.intro }}
        <div class="product-intro">{{ . | markdownify }}</div>
        {{ end }}
        {{ $subject := printf "%s: %s" site.Params.orderSubject .Title }}
        {{ $body := printf "%s%s" site.Params.orderBody .Title }}
        <a href="mailto:{{ site.Params.email }}?subject={{ $subject | urlquery }}&body={{ $body | urlquery }}"
           class="btn btn-primary btn-order">
          {{ site.Params.orderButtonText }}
        </a>
      </div>
      {{ with .Params.image }}
      <div class="product-hero-image">
        <img src="{{ . | relURL }}" alt="{{ $.Title }}">
      </div>
      {{ end }}
    </div>

    {{/* Helper: video extensions */}}
    {{/* ===== TOP-LEVEL CONTENT (always shown if present) ===== */}}
    {{ $hasTopContent := or .Params.gallery .Content }}
    {{ $versionOffset := 0 }}
    {{ if $hasTopContent }}
    <div class="product-version" data-version="0">
      <div class="product-detail-grid">
        <div class="product-detail-media">
          <div class="media-main-wrap">
            <div class="media-main" onclick="openLightbox(0)">
              {{ with .Params.image }}
              <img src="{{ . | relURL }}" alt="{{ $.Title }}" class="media-main-img">
              {{ else }}
              <div class="product-image product-image--placeholder product-image--large">
                <span>&#9733;</span>
              </div>
              {{ end }}
            </div>
            {{ if .Params.gallery }}
            <button class="media-nav media-nav--prev" onclick="verPrev(event, 0)">&#10094;</button>
            <button class="media-nav media-nav--next" onclick="verNext(event, 0)">&#10095;</button>
            {{ end }}
          </div>

          {{ if .Params.gallery }}
          <div class="media-thumbs">
            {{ with .Params.image }}
            <div class="thumb thumb--active" onclick="verShow(0, 0)" data-type="image">
              <img src="{{ . | relURL }}" alt="{{ $.Title }}" loading="lazy">
            </div>
            {{ end }}
            {{ range $i, $item := .Params.gallery }}
            {{ $ext := path.Ext $item }}
            {{ $isVideo := or (eq $ext ".mp4") (eq $ext ".webm") (eq $ext ".mov") (eq $ext ".MP4") }}
            {{ $idx := $i }}{{ if $.Params.image }}{{ $idx = add $i 1 }}{{ end }}
            {{ if $isVideo }}
            <div class="thumb thumb--video" onclick="verShow(0, {{ $idx }})" data-type="video">
              <video src="{{ $item | relURL }}" preload="metadata" muted></video>
              <span class="thumb-play">&#9654;</span>
            </div>
            {{ else }}
            <div class="thumb" onclick="verShow(0, {{ $idx }})" data-type="image">
              <img src="{{ $item | relURL }}" alt="{{ $.Title }}" loading="lazy">
            </div>
            {{ end }}
            {{ end }}
          </div>
          {{ end }}
        </div>

        <div class="product-detail-info">
          {{ with .Params.price }}
          <p class="product-detail-price">{{ site.Params.priceLabel }}: {{ site.Params.currency }} {{ . }}</p>
          {{ end }}
          <div class="product-detail-description">
            {{ .Content }}
          </div>
          {{ $subject := printf "%s: %s" site.Params.orderSubject .Title }}
          {{ $body := printf "%s%s" site.Params.orderBody .Title }}
          <a href="mailto:{{ site.Params.email }}?subject={{ $subject | urlquery }}&body={{ $body | urlquery }}"
             class="btn btn-primary btn-order">
            {{ site.Params.orderButtonText }}
          </a>
        </div>
      </div>
    </div>
    {{ $versionOffset = 1 }}
    {{ end }}

    {{/* ===== NAMED VERSIONS (shown after top-level content) ===== */}}
    {{ range $vi, $version := .Params.versions }}
    {{ $idx := add $vi $versionOffset }}
    <div class="product-version" data-version="{{ $idx }}">
      <h2 class="product-version-title">{{ $version.name }}</h2>
      <div class="product-detail-grid">
        <div class="product-detail-media">
          <div class="media-main-wrap">
            <div class="media-main" onclick="openLightbox({{ $idx }})">
              {{ if $version.gallery }}
              {{ $first := index $version.gallery 0 }}
              {{ $firstExt := path.Ext $first }}
              {{ $firstIsVideo := or (eq $firstExt ".mp4") (eq $firstExt ".webm") (eq $firstExt ".mov") (eq $firstExt ".MP4") }}
              {{ if $firstIsVideo }}
              <video src="{{ $first | relURL }}" class="media-main-video" preload="metadata" muted></video>
              {{ else }}
              <img src="{{ $first | relURL }}" alt="{{ $version.name }}" class="media-main-img">
              {{ end }}
              {{ else }}
              <div class="product-image product-image--placeholder product-image--large">
                <span>&#9733;</span>
              </div>
              {{ end }}
            </div>
            {{ if $version.gallery }}
            {{ if gt (len $version.gallery) 1 }}
            <button class="media-nav media-nav--prev" onclick="verPrev(event, {{ $idx }})">&#10094;</button>
            <button class="media-nav media-nav--next" onclick="verNext(event, {{ $idx }})">&#10095;</button>
            {{ end }}
            {{ end }}
          </div>

          {{ if $version.gallery }}
          <div class="media-thumbs">
            {{ range $gi, $item := $version.gallery }}
            {{ $ext := path.Ext $item }}
            {{ $isVideo := or (eq $ext ".mp4") (eq $ext ".webm") (eq $ext ".mov") (eq $ext ".MP4") }}
            {{ if $isVideo }}
            <div class="thumb thumb--video{{ if eq $gi 0 }} thumb--active{{ end }}" onclick="verShow({{ $idx }}, {{ $gi }})" data-type="video">
              <video src="{{ $item | relURL }}" preload="metadata" muted></video>
              <span class="thumb-play">&#9654;</span>
            </div>
            {{ else }}
            <div class="thumb{{ if eq $gi 0 }} thumb--active{{ end }}" onclick="verShow({{ $idx }}, {{ $gi }})" data-type="image">
              <img src="{{ $item | relURL }}" alt="{{ $version.name }}" loading="lazy">
            </div>
            {{ end }}
            {{ end }}
          </div>
          {{ end }}
        </div>

        <div class="product-detail-info">
          <div class="product-detail-description">
            {{ $version.details | markdownify }}
          </div>
        </div>
      </div>
    </div>
    {{ end }}

    {{/* ===== FOOTER: order + back buttons ===== */}}
    {{/* ===== FOOTER: editable text + order + back buttons ===== */}}
    {{ $footer := site.GetPage "/product-footer" }}
    <div class="product-footer">
      {{ with $footer }}
      <div class="product-footer-text">{{ .Content }}</div>
      {{ end }}
      {{ $subject := printf "%s: %s" site.Params.orderSubject .Title }}
      {{ $body := printf "%s%s" site.Params.orderBody .Title }}
      <a href="mailto:{{ site.Params.email }}?subject={{ $subject | urlquery }}&body={{ $body | urlquery }}"
         class="btn btn-primary btn-order">
        {{ site.Params.orderButtonText }}
      </a>
      <a href="{{ .Parent.RelPermalink }}" class="btn btn-secondary">&larr; {{ site.Params.allProductsText }}</a>
    </div>
  </div>
</article>

{{/* Lightbox overlay (shared) */}}
<div class="lightbox" id="lightbox" onclick="lbClick(event)">
  <button class="lightbox-close" onclick="lbClose()">&times;</button>
  <button class="lightbox-prev" onclick="lbPrev(event)">&#10094;</button>
  <div class="lightbox-content" id="lightbox-content"></div>
  <button class="lightbox-next" onclick="lbNext(event)">&#10095;</button>
  <div class="lightbox-counter" id="lightbox-counter"></div>
</div>

<script>
// Build media items per version section
var versions = [];
(function() {
  var sections = document.querySelectorAll('.product-version');
  sections.forEach(function(section) {
    var items = [];
    var thumbs = section.querySelectorAll('.thumb');
    thumbs.forEach(function(t) {
      var type = t.getAttribute('data-type');
      if (type === 'image') {
        var img = t.querySelector('img');
        if (img) items.push({ type: 'image', src: img.src });
      } else if (type === 'video') {
        var vid = t.querySelector('video');
        if (vid) items.push({ type: 'video', src: vid.src });
      }
    });
    versions.push({ items: items, currentIndex: 0 });
  });
})();

var activeLbVersion = 0;
var lbIndex = 0;

function verShow(vi, idx) {
  var ver = versions[vi];
  if (!ver || !ver.items.length) return;
  ver.currentIndex = idx;
  var item = ver.items[idx];
  var section = document.querySelectorAll('.product-version')[vi];
  var main = section.querySelector('.media-main');
  if (item.type === 'image') {
    main.innerHTML = '<img src="' + item.src + '" alt="" class="media-main-img">';
  } else {
    main.innerHTML = '<video src="' + item.src + '" controls playsinline autoplay class="media-main-video"></video>';
  }
  var thumbs = section.querySelectorAll('.thumb');
  thumbs.forEach(function(t, i) {
    t.classList.toggle('thumb--active', i === idx);
  });
}

function verNext(e, vi) {
  if (e) { e.stopPropagation(); e.preventDefault(); }
  var ver = versions[vi];
  if (!ver || !ver.items.length) return;
  verShow(vi, (ver.currentIndex + 1) % ver.items.length);
}

function verPrev(e, vi) {
  if (e) { e.stopPropagation(); e.preventDefault(); }
  var ver = versions[vi];
  if (!ver || !ver.items.length) return;
  verShow(vi, (ver.currentIndex - 1 + ver.items.length) % ver.items.length);
}

function openLightbox(vi) {
  activeLbVersion = vi;
  var ver = versions[vi];
  if (!ver || !ver.items.length) return;
  lbIndex = ver.currentIndex;
  lbShow();
  document.getElementById('lightbox').classList.add('lightbox--open');
  document.body.style.overflow = 'hidden';
}

function lbShow() {
  var ver = versions[activeLbVersion];
  if (!ver || !ver.items.length) return;
  var item = ver.items[lbIndex];
  var content = document.getElementById('lightbox-content');
  if (item.type === 'image') {
    content.innerHTML = '<img src="' + item.src + '" alt="">';
  } else {
    content.innerHTML = '<video src="' + item.src + '" controls playsinline autoplay></video>';
  }
  document.getElementById('lightbox-counter').textContent = (lbIndex + 1) + ' / ' + ver.items.length;
}

function lbNext(e) {
  if (e) e.stopPropagation();
  var ver = versions[activeLbVersion];
  if (!ver) return;
  lbIndex = (lbIndex + 1) % ver.items.length;
  lbShow();
}

function lbPrev(e) {
  if (e) e.stopPropagation();
  var ver = versions[activeLbVersion];
  if (!ver) return;
  lbIndex = (lbIndex - 1 + ver.items.length) % ver.items.length;
  lbShow();
}

function lbClose() {
  document.getElementById('lightbox').classList.remove('lightbox--open');
  document.body.style.overflow = '';
  var vid = document.querySelector('#lightbox-content video');
  if (vid) vid.pause();
}

function lbClick(e) {
  if (e.target.classList.contains('lightbox')) lbClose();
}

document.addEventListener('keydown', function(e) {
  var lb = document.getElementById('lightbox');
  if (lb.classList.contains('lightbox--open')) {
    if (e.key === 'Escape') lbClose();
    if (e.key === 'ArrowRight') lbNext();
    if (e.key === 'ArrowLeft') lbPrev();
  }
});
</script>
{{ end }}
